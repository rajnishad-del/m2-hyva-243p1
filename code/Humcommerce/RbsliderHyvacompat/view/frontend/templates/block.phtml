<?php

declare(strict_types=1);

//import methods from app/code/Aheadworks/Rbslider/Block/Banner.php
use Aheadworks\Rbslider\Block\Banner;

//$escaper protects your website from XSS (Cross-Site Scripting) attacks by sanitizing dynamic 
//content before displaying it in HTML, JavaScript, URLs, or CSS. 
//It's a security tool that ensures malicious code can't be injected through user input or database content.
use Magento\Framework\Escaper;

/** @var Banner $block */
/** @var Escaper $escaper */

?>

<script>
    // User hits URL
    // Server sends HTML
    // Browser parses HTML, builds DOM
    // Alpine.js file (alpine3.min.js) loads and executes
    // Alpine creates component (x-data='initAwRbslider(...)')
    // Alpine init() runs (x-init='init()')
    // Intersection Observer setup (x-intersect.once="initSlider()")
    // Page rendered, user sees content

    // STATUS:
    // ├─alpine3.min.js loaded
    // ├─Alpine component created
    // ├─Intersection Observer watching banner
    // ├─slideshow.js NOT loaded yet (not needed yet!)
    // └─Banner below viewport

    // Banner enters viewport
    // │
    // ├─→ x-intersect.once triggers
    // │   │
    // │   └─→ initSlider() called
    // │       │
    // │       ├─→ Check if window.awRbslider exists
    // │       │   └─→ NO, it doesn't exist (slideshow.js not loaded!)
    // │       │
    // │       ├─→ load slideshow.js
    // │       │   │
    // │       │   └─→ loadScript() called
    // │       │       │
    // │       │       ├─→ Create <script> element
    // │       │       ├─→ Set src = ".../slideshow.js"
    // │       │       ├─→ Append to <head>
    // │       │       └─→ Browser requests slideshow.js from server
    // │       │           └─→ GET /static/.../slideshow.js
    // │       │
    // │       ├─→ Wait for script to load (checkAndInit loop)
    // │       │
    // │       └─→ (Continue after script loads...)

    'use strict';

    function initAwRbslider(config) {
        return {
            options: Object.assign({
                autoplay: true,
                pauseTimeBetweenTransitions: 3000,
                slideTransitionSpeed: 500,
                isStopAnimationMouseOnBanner: true,
                animation: 'fade',
                isRandomOrderImage: false,
                sliderListSelector: '.uk-slideshow',
                sliderItemSelector: '.aw-rbslider-item'
            }, config),

            slideshow: null,
            isInitialized: false,

            init() {
                if (this.options.bannerSchedule && this.options.bannerSchedule.length > 0) {
                    if (!this.timeValidator([this.options.bannerSchedule[0]])) {
                        this.delayedUpdate(this.options.bannerSchedule[0]);
                    }
                    if (this.timeValidator(this.options.bannerSchedule)) {
                        this.sendRequest(this.options.bannerId);
                    }
                }
            },

            initSlider() {
                if (this.isInitialized) return;

                // Wait for script to be loaded
                const checkAndInit = () => {
                    if (typeof window.awRbslider === 'function') {
                        this.isInitialized = true;
                        this.slideshow = window.awRbslider(this.$el, {
                            autoplay: this.options.autoplay,
                            autoplayInterval: this.options.pauseTimeBetweenTransitions,
                            duration: this.options.slideTransitionSpeed,
                            pauseOnHover: this.options.isStopAnimationMouseOnBanner,
                            animation: this.options.animation
                        });

                        // Initialize the slideshow
                        this.slideshow.init();

                        // Load slides lazily
                        this.loadSlides();
                    } else if (!window.awRbsliderLoading) {
                        this.loadScript();
                        setTimeout(checkAndInit, 100);
                    } else {
                        setTimeout(checkAndInit, 100);
                    }
                };

                checkAndInit();
            },

            loadScript() {
                if (window.awRbsliderLoading || window.awRbslider) return;

                window.awRbsliderLoading = true;

                const script = document.createElement('script');
                script.src = `<?= $escaper->escapeJs($block->getViewFileUrl("Humcommerce_RbsliderHyvacompat/js/components/slideshow.js")) ?>`;

                script.onload = () => {
                    console.log('RbsliderHyvacompat slideshow script loaded');
                    window.awRbsliderLoading = false;
                };

                script.onerror = () => {
                    console.error('Failed to load RbsliderHyvacompat slideshow script');
                    window.awRbsliderLoading = false;
                };

                document.head.appendChild(script);
            },

            handleNavClick(type, event) {
                event.preventDefault();

                if (!this.slideshow) return;

                if (type === 'previous') {
                    this.slideshow.previous();
                } else if (type === 'next') {
                    this.slideshow.next();
                } else if (typeof type === 'number') {
                    this.slideshow.show(type);
                }

                // Restart autoplay if enabled
                if (this.slideshow.options.autoplay) {
                    this.slideshow.start();
                }
            },

            pauseOnEnter() {
                if (this.slideshow && this.slideshow.options.pauseOnHover) {
                    this.slideshow.hovering = true;
                }
            },

            resumeOnLeave() {
                if (this.slideshow) {
                    this.slideshow.hovering = false;
                }
            },

            loadSlides() {
                const slides = this.$el.querySelectorAll('.aw-rbslider-item');

                slides.forEach((slideElem, index) => {
                    if (index > 0) {
                        const slideImg = slideElem.querySelector('img.aw-rbslider__img');
                        if (slideImg && slideImg.dataset.src) {
                            slideImg.addEventListener('load', () => {
                                slideImg.classList.add('is-loaded');
                            });
                            slideImg.src = slideImg.dataset.src;
                            slideImg.removeAttribute('data-src');
                        }
                    }
                });
            },

            timeValidator(schedule) {
                const currentDate = new Date();
                const currentMinute = Math.floor(currentDate.getTime() / 1000 / 60);
                let isValid = false;

                schedule.forEach(item => {
                    const scheduleDate = new Date(item);
                    const scheduleMinute = Math.floor(scheduleDate.getTime() / 1000 / 60);
                    if (currentMinute === scheduleMinute) {
                        isValid = true;
                    }
                });

                return isValid;
            },

            sendRequest(bannerId) {
                if (!this.options.cacheCleanUrl) return;

                fetch(this.options.cacheCleanUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bannerId: bannerId
                    })
                }).catch(err => console.error('Cache clean request failed:', err));
            },

            delayedUpdate(futureTime) {
                const currentDate = new Date();
                const futureDate = new Date(futureTime);
                const interval = futureDate.getTime() - currentDate.getTime();

                if (interval > 0) {
                    setTimeout(() => this.sendRequest(this.options.bannerId), interval);
                }
            }
        };
    }
</script>


<?php if ($bannersBlock = $block->getBlocks()): ?>
    <?php foreach ($bannersBlock as $bannerBlock) : ?>
        <?php
        $dotNavItems = ''; // Initialize dot navigation items
        $slideCounter = 1; // To track the first slide for lazy loading
        $sliderConfig = $block->getBannerMageInitParams($bannerBlock)['awRbslider'];
        ?>
        <div
            x-data='initAwRbslider(<?= /* @noEscape */ $block->jsonEncode($sliderConfig) ?>)'
            x-init='init()'
            x-intersect.once="initSlider()"
            data-aw-rbslider-banner-id='<?= /* @noEscape */ $bannerBlock->getBanner()->getId(); ?>'
            class="aw-rbslider-container uk-slidenav-position">
            <div class="uk-slideshow uk-overlay-active">
                <?php foreach ($bannerBlock->getSlides() as $key => $slide) : ?>
                    <div class="aw-rbslider-item">
                        <div class="aw-rbslider-img-wrapper">
                            <picture>
                                <source media="(max-width: 480px)"
                                    srcset="<?= /* @noEscape */ $block->getSlideMobileImgUrl($slide) ?>"
                                    class="aw-rbslider__img <?= $slideCounter === 1 ? 'is-loaded' : '' ?>"
                                    <?= $slideCounter !== 1 ? 'data-' : '' ?>
                                    title="<?= $escaper->escapeHtml($slide->getImgTitle()) ?>" />
                                <img class="aw-rbslider__img <?= $slideCounter === 1 ? 'is-loaded' : '' ?>"
                                    <?= $slideCounter !== 1 ? 'data-' : '' ?>src="<?= /* @noEscape */ $block->getSlideImgUrl($slide) ?>"
                                    title="<?= $escaper->escapeHtml($slide->getImgTitle()) ?>"
                                    alt="<?= $escaper->escapeHtml($slide->getImgAlt()) ?>" />
                            </picture>
                            <?php if ($slide->getUrl()): ?>
                                <?php
                                $target = $slide->getIsOpenUrlInNewWindow() ? 'target="_blank"' : '';
                                $nofollow = $slide->getIsAddNofollowToUrl() ? 'rel="nofollow"' : '';
                                ?>
                                <a href="<?= /* @noEscape */ $slide->getUrl() ?>"
                                    class="aw-rbslider-img-url"
                                    data-mage-init='<?= /* @noEscape */ $block->jsonEncode($block->getSendClickStatisticsMageInitParams($bannerBlock->getBanner(), $slide)) ?>'
                                    <?= /* @noEscape */ $target ?>
                                    <?= /* @noEscape */ $nofollow ?>></a>
                            <?php endif; ?>
                            <?php if ($content = $slide->getContent()): ?>
                                <div class="aw-rbslider-content-wrapper uk-overlay-panel uk-flex uk-flex-center uk-flex-middle uk-text-center">
                                    <div>
                                        <?= /* @noEscape */ $content ?>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    <?php $dotNavItems .= '<li data-slide-index="' . $key . '"><a href="#" @click="handleNavClick(' . $key . ', $event)"></a></li>'; ?>
                    <?php $slideCounter++; ?>
                <?php endforeach; ?>
            </div>
            <?php if (count($bannerBlock->getSlides()) > 1): ?>
                <?php if ($bannerBlock->getBanner()->getDisplayArrows()) : ?>
                    <a href="#"
                        class="uk-slidenav uk-slidenav-contrast uk-slidenav-previous"
                        @mouseenter="pauseOnEnter()"
                        @mouseleave="resumeOnLeave()"
                        @click="handleNavClick('previous', $event)">
                        <span class="visually-hidden"><?= $escaper->escapeHtml(__('Show previous slide')) ?></span>
                    </a>
                    <a href="#"
                        class="uk-slidenav uk-slidenav-contrast uk-slidenav-next"
                        @mouseenter="pauseOnEnter()"
                        @mouseleave="resumeOnLeave()"
                        @click="handleNavClick('next', $event)">
                        <span class="visually-hidden"><?= $escaper->escapeHtml(__('Show next slide')) ?></span>
                    </a>
                <?php endif; ?>
                <?php if ($bannerBlock->getBanner()->getDisplayBullets()) : ?>
                    <ul class="uk-dotnav uk-dotnav-contrast uk-position-bottom uk-flex-center"
                        @mouseenter="pauseOnEnter()"
                        @mouseleave="resumeOnLeave()">
                        <?= /* @noEscape */ $dotNavItems ?>
                    </ul>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    <?php endforeach; ?>
<?php endif; ?>